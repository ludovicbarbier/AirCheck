<!doctype html>
<html class="no-js" lang="">
<head>
	<meta charset="utf-8">
	<meta http-equiv="x-ua-compatible" content="ie=edge">
	<title>AirCheck</title>
	<meta name="description" content="">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<link rel="apple-touch-icon" href="apple-touch-icon.png">
	<!-- Place favicon.ico in the root directory -->

	<link rel="stylesheet" href="css/normalize.css">
	<link rel="stylesheet" href="css/main.css">
	<link rel="stylesheet" href="http://openlayers.org/en/v3.15.1/css/ol.css" type="text/css">
	<script src="http://openlayers.org/en/v3.15.1/build/ol.js"></script>
	<script src="js/vendor/modernizr-2.8.3.min.js"></script>
</head>
<body>
<!--[if lt IE 8]>
<p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade
	your browser</a> to improve your experience.</p>
<![endif]-->

<section id="controls">

</section>
<section id="map" class="map"></section>


<script src="https://code.jquery.com/jquery-1.12.0.min.js"></script>
<script>window.jQuery || document.write('<script src="js/vendor/jquery-1.12.0.min.js"><\/script>')</script>
<script src="js/plugins.js"></script>
<script src="js/main.js"></script>
<script>
	var symptomFill = new ol.style.Fill({
		color: 'rgba(255, 153, 0, 0.8)'
	});
	var symptomStroke = new ol.style.Stroke({
		color: 'rgba(255, 204, 0, 0.2)',
		width: 1
	});
	var textFill = new ol.style.Fill({
		color: '#fff'
	});
	var textStroke = new ol.style.Stroke({
		color: 'rgba(0, 0, 0, 0.6)',
		width: 3
	});
	var invisibleFill = new ol.style.Fill({
		color: 'rgba(255, 255, 255, 0.01)'
	});

	function createEarthquakeStyle(feature) {
		// 2012_Earthquakes_Mag5.kml stores the magnitude of each symptom in a
		// standards-violating <magnitude> tag in each Placemark.  We extract it
		// from the Placemark's name instead.
		var name = feature.get('name');
		var magnitude = parseFloat(name.substr(2));
		var radius = 5 + 20 * (magnitude - 5);

		return new ol.style.Style({
			geometry: feature.getGeometry(),
			image: new ol.style.RegularShape({
				radius1: radius,
				points: 1,
				angle: Math.PI,
				fill: symptomFill,
				stroke: symptomStroke
			})
		});
	}

	var maxFeatureCount, symptomLayer;
	function calculateClusterInfo(resolution) {
		maxFeatureCount = 0;
		var features = symptomLayer.getSource().getFeatures();
		var feature, radius;
		for (var i = features.length - 1; i >= 0; --i) {
			feature = features[i];
			var originalFeatures = feature.get('features');
			var extent = ol.extent.createEmpty();
			var j, jj;
			for (j = 0, jj = originalFeatures.length; j < jj; ++j) {
				ol.extent.extend(extent, originalFeatures[j].getGeometry().getExtent());
			}
			maxFeatureCount = Math.max(maxFeatureCount, jj);
			radius = 0.25 * (ol.extent.getWidth(extent) + ol.extent.getHeight(extent)) /
					resolution;
			feature.set('radius', radius);
		}
	}

	var currentResolution;
	function styleFunction(feature, resolution) {
		if (resolution != currentResolution) {
			calculateClusterInfo(resolution);
			currentResolution = resolution;
		}
		var style;
		var size = feature.get('features').length;
		if (size > 1) {
			style = new ol.style.Style({
				image: new ol.style.Circle({
					radius: feature.get('radius'),
					fill: new ol.style.Fill({
						color: [255, 153, 0, Math.min(0.8, 0.4 + (size / maxFeatureCount))]
					})
				}),
				text: new ol.style.Text({
					text: size.toString(),
					fill: textFill,
					stroke: textStroke
				})
			});
		} else {
			var originalFeature = feature.get('features')[0];
			style = createEarthquakeStyle(originalFeature);
		}
		return style;
	}

	function selectStyleFunction(feature) {
		var styles = [new ol.style.Style({
			image: new ol.style.Circle({
				radius: feature.get('radius'),
				fill: invisibleFill
			})
		})];
		var originalFeatures = feature.get('features');
		var originalFeature;
		for (var i = originalFeatures.length - 1; i >= 0; --i) {
			originalFeature = originalFeatures[i];
			styles.push(createEarthquakeStyle(originalFeature));
		}
		return styles;
	}

	symptomLayer = new ol.layer.Vector({
		source: new ol.source.Cluster({
			distance: 40,
			source: new ol.source.Vector({
				url: 'sample/2012_Earthquakes_Mag5.kml',
				format: new ol.format.KML({
					extractStyles: false
				})
			})
		}),
		style: styleFunction
	});

	var source = new ol.source.WMTS({
		url: "//map1{a-c}.vis.earthdata.nasa.gov/wmts-geo/wmts.cgi?TIME=2013-06-16",
		layer: "MODIS_Terra_CorrectedReflectance_TrueColor",
		format: "image/jpeg",
		matrixSet: "EPSG4326_250m",
		tileGrid: new ol.tilegrid.WMTS({
			origin: [-180, 90],
			resolutions: [
				0.5625,
				0.28125,
				0.140625,
				0.0703125,
				0.03515625,
				0.017578125,
				0.0087890625,
				0.00439453125,
				0.002197265625
			],
			matrixIds: [0, 1, 2, 3, 4, 5, 6, 7, 8],
			tileSize: 512
		})
	});

	var mapLayer = new ol.layer.Tile({
		source: source
	});

	var map = new ol.Map({
		layers: [mapLayer, symptomLayer],
		target: 'map',
		view: new ol.View({
			maxResolution: 0.5625,
			projection: ol.proj.get("EPSG:4326"),
			extent: [-180, -90, 180, 90],
			center: [0, 0],
			zoom: 2,
			maxZoom: 8
		}),
		renderer: ["canvas", "dom"]
	});

</script>
<!-- Google Analytics: change UA-XXXXX-X to be your site's ID. -->
<script>
	(function (b, o, i, l, e, r) {
		b.GoogleAnalyticsObject = l;
		b[l] || (b[l] =
				function () {
					(b[l].q = b[l].q || []).push(arguments)
				});
		b[l].l = +new Date;
		e = o.createElement(i);
		r = o.getElementsByTagName(i)[0];
		e.src = 'https://www.google-analytics.com/analytics.js';
		r.parentNode.insertBefore(e, r)
	}(window, document, 'script', 'ga'));
	ga('create', 'UA-XXXXX-X', 'auto');
	ga('send', 'pageview');
</script>
</body>
</html>
